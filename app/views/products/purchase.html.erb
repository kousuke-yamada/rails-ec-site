<% content_for :title, "è³¼å…¥æ‰‹ç¶šã - ãƒ¡ãƒ«ã‚«ãƒª" %>

<%= content_for :head do %>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f8f8;
      line-height: 1.6;
      color: #333;
    }
    
    .header {
      background: white;
      padding: 16px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #ea352d;
      text-decoration: none;
    }
    
    .breadcrumb {
      color: #888;
      font-size: 14px;
    }
    
    .breadcrumb a {
      color: #888;
      text-decoration: none;
    }
    
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px 16px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 32px;
      color: #333;
    }
    
    .form-section {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .product-summary {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .product-image {
      width: 80px;
      height: 80px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .product-details {
      flex: 1;
    }
    
    .product-name {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    
    .product-price {
      font-size: 20px;
      font-weight: bold;
      color: #ea352d;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.2s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #ea352d;
      box-shadow: 0 0 0 2px rgba(234, 53, 45, 0.1);
    }
    
    .address-row {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px;
    }
    
    .saved-address {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .saved-address:hover {
      border-color: #ea352d;
      background: #fff5f5;
    }
    
    .saved-address.selected {
      border-color: #ea352d;
      background: #fff5f5;
    }
    
    .address-label {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .address-details {
      color: #666;
      font-size: 14px;
    }
    
    .payment-method {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .payment-method:hover {
      border-color: #ea352d;
      background: #fff5f5;
    }
    
    .payment-method.selected {
      border-color: #ea352d;
      background: #fff5f5;
    }
    
    .payment-icon {
      font-size: 24px;
    }
    
    .payment-info {
      flex: 1;
    }
    
    .payment-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .payment-desc {
      font-size: 14px;
      color: #666;
    }
    
    .radio-input {
      width: 20px;
      height: 20px;
      margin-left: auto;
    }
    
    .price-breakdown {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .price-row.total {
      font-size: 20px;
      font-weight: bold;
      color: #ea352d;
      border-top: 1px solid #ddd;
      padding-top: 12px;
      margin-top: 16px;
      margin-bottom: 0;
    }
    
    .coupon-section {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .coupon-input {
      display: flex;
      gap: 8px;
    }
    
    .coupon-btn {
      background: #666;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .coupon-btn:hover {
      background: #555;
    }
    
    .purchase-button {
      width: 100%;
      background: #ea352d;
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 16px;
    }
    
    .purchase-button:hover {
      background: #d32f2f;
    }
    
    .purchase-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .terms-notice {
      font-size: 14px;
      color: #666;
      text-align: center;
      line-height: 1.5;
    }
    
    .terms-notice a {
      color: #ea352d;
      text-decoration: none;
    }
    
    .terms-notice a:hover {
      text-decoration: underline;
    }
    
    .security-notice {
      background: #e8f5e8;
      border: 1px solid #c3e6c3;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .security-icon {
      font-size: 24px;
      color: #28a745;
    }
    
    .security-text {
      font-size: 14px;
      color: #155724;
    }
    
    .error-message {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 14px;
      color: #721c24;
      display: none;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 16px 8px;
      }
      
      .form-section {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .product-summary {
        flex-direction: column;
        text-align: center;
      }
      
      .address-row {
        grid-template-columns: 1fr;
      }
      
      .payment-method {
        flex-direction: column;
        text-align: center;
      }
      
      .radio-input {
        margin: 12px auto 0;
      }
    }
  </style>
<% end %>

<header class="header">
  <div class="header-content">
    <a href="/" class="logo">ãƒ¡ãƒ«ã‚«ãƒª</a>
    <div class="breadcrumb">
      <a href="/">ãƒ›ãƒ¼ãƒ </a> > 
      <a href="#">å•†å“è©³ç´°</a> > 
      è³¼å…¥æ‰‹ç¶šã
    </div>
  </div>
</header>

<div class="container">
  <h1 class="page-title">è³¼å…¥æ‰‹ç¶šã</h1>

  <%= form_with url: "#", method: :post, local: true, id: "purchaseForm" do |form| %>
    <!-- å•†å“æƒ…å ± -->
    <div class="form-section">
      <h2 class="section-title">è³¼å…¥å•†å“</h2>
      <div class="product-summary">
        <div class="product-image">
          <img src="https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=80&h=80&fit=crop" alt="iPhone 14 Pro">
        </div>
        <div class="product-details">
          <div class="product-name">iPhone 14 Pro 256GB ã‚¹ãƒšãƒ¼ã‚¹ãƒ–ãƒ©ãƒƒã‚¯ SIMãƒ•ãƒªãƒ¼</div>
          <div class="product-price">Â¥ 145,000</div>
        </div>
      </div>
    </div>

    <!-- é…é€å…ˆä½æ‰€ -->
    <div class="form-section">
      <h2 class="section-title">é…é€å…ˆ</h2>
      
      <div class="saved-address selected" onclick="selectAddress(this)">
        <div class="address-label">è‡ªå®…</div>
        <div class="address-details">
          ã€’150-0001 æ±äº¬éƒ½æ¸‹è°·åŒºç¥å®®å‰1-1-1<br>
          å±±ç”° å¤ªéƒ
        </div>
      </div>
      
      <div class="saved-address" onclick="selectAddress(this)">
        <div class="address-label">å®Ÿå®¶</div>
        <div class="address-details">
          ã€’100-0001 æ±äº¬éƒ½åƒä»£ç”°åŒºåƒä»£ç”°1-1-1<br>
          å±±ç”° å¤ªéƒ
        </div>
      </div>

      <div class="form-group">
        <%= form.label :new_address, "æ–°ã—ã„ä½æ‰€ã‚’è¿½åŠ ", class: "form-label" %>
        <div class="address-row">
          <%= form.text_field :postal_code, class: "form-input", placeholder: "éƒµä¾¿ç•ªå·", maxlength: 8 %>
          <%= form.text_field :address, class: "form-input", placeholder: "éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ°" %>
        </div>
        <%= form.text_field :building, class: "form-input", placeholder: "å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·", style: "margin-top: 12px;" %>
        <%= form.text_field :recipient_name, class: "form-input", placeholder: "å—å–äººå", style: "margin-top: 12px;" %>
      </div>
    </div>

    <!-- æ”¯æ‰•ã„æ–¹æ³• -->
    <div class="form-section">
      <h2 class="section-title">æ”¯æ‰•ã„æ–¹æ³•</h2>
      
      <div class="payment-method selected" onclick="selectPayment(this)">
        <div class="payment-icon">ğŸ’³</div>
        <div class="payment-info">
          <div class="payment-name">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</div>
          <div class="payment-desc">**** **** **** 1234ï¼ˆVISAï¼‰</div>
        </div>
        <%= form.radio_button :payment_method, "credit", class: "radio-input", checked: true %>
      </div>
      
      <div class="payment-method" onclick="selectPayment(this)">
        <div class="payment-icon">ğŸª</div>
        <div class="payment-info">
          <div class="payment-name">ã‚³ãƒ³ãƒ“ãƒ‹æ”¯æ‰•ã„</div>
          <div class="payment-desc">è³¼å…¥å¾Œã«ãŠæ”¯æ‰•ã„ç”¨ç•ªå·ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™</div>
        </div>
        <%= form.radio_button :payment_method, "convenience", class: "radio-input" %>
      </div>
      
      <div class="payment-method" onclick="selectPayment(this)">
        <div class="payment-icon">ğŸ§</div>
        <div class="payment-info">
          <div class="payment-name">ATMæ”¯æ‰•ã„</div>
          <div class="payment-desc">Pay-easyå¯¾å¿œATMã§ãŠæ”¯æ‰•ã„ãã ã•ã„</div>
        </div>
        <%= form.radio_button :payment_method, "atm", class: "radio-input" %>
      </div>
      
      <div class="payment-method" onclick="selectPayment(this)">
        <div class="payment-icon">ğŸ“±</div>
        <div class="payment-info">
          <div class="payment-name">ãƒ¡ãƒ«ãƒšã‚¤ã‚¹ãƒãƒ¼ãƒˆæ‰•ã„</div>
          <div class="payment-desc">ç¿Œæœˆã¾ã¨ã‚ã¦ãŠæ”¯æ‰•ã„</div>
        </div>
        <%= form.radio_button :payment_method, "merpay", class: "radio-input" %>
      </div>
    </div>

    <!-- ã‚¯ãƒ¼ãƒãƒ³ãƒ»ãƒã‚¤ãƒ³ãƒˆ -->
    <div class="form-section">
      <h2 class="section-title">ã‚¯ãƒ¼ãƒãƒ³ãƒ»ãƒã‚¤ãƒ³ãƒˆ</h2>
      
      <div class="coupon-section">
        <%= form.label :coupon_code, "ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰", class: "form-label" %>
        <div class="coupon-input">
          <%= form.text_field :coupon_code, class: "form-input", placeholder: "ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›", id: "couponCode" %>
          <button type="button" class="coupon-btn" onclick="applyCoupon()">é©ç”¨</button>
        </div>
        <div class="error-message" id="couponError">ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™</div>
      </div>
      
      <div class="form-group">
        <%= form.label :points_used, "ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨", class: "form-label" %>
        <div style="display: flex; align-items: center; gap: 12px;">
          <%= form.number_field :points_used, class: "form-input", placeholder: "0", min: 0, max: 1500, style: "flex: 1;" %>
          <span style="color: #666;">/ 1,500P åˆ©ç”¨å¯èƒ½</span>
        </div>
      </div>
    </div>

    <!-- æ–™é‡‘è©³ç´° -->
    <div class="form-section">
      <h2 class="section-title">ãŠæ”¯æ‰•ã„é‡‘é¡</h2>
      <div class="price-breakdown">
        <div class="price-row">
          <span>å•†å“ä»£é‡‘</span>
          <span>Â¥ 145,000</span>
        </div>
        <div class="price-row">
          <span>é€æ–™</span>
          <span>Â¥ 0</span>
        </div>
        <div class="price-row">
          <span>ã‚¯ãƒ¼ãƒãƒ³å‰²å¼•</span>
          <span id="couponDiscount">Â¥ 0</span>
        </div>
        <div class="price-row">
          <span>ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨</span>
          <span id="pointDiscount">Â¥ 0</span>
        </div>
        <div class="price-row total">
          <span>åˆè¨ˆ</span>
          <span id="totalAmount">Â¥ 145,000</span>
        </div>
      </div>
    </div>

    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é€šçŸ¥ -->
    <div class="security-notice">
      <div class="security-icon">ğŸ”’</div>
      <div class="security-text">
        <strong>å®‰å…¨ãªæ±ºæ¸ˆ</strong><br>
        ãŠå®¢æ§˜ã®å€‹äººæƒ…å ±ã¨ãŠæ”¯æ‰•ã„æƒ…å ±ã¯æš—å·åŒ–ã•ã‚Œã¦ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚
      </div>
    </div>

    <!-- è³¼å…¥ãƒœã‚¿ãƒ³ -->
    <%= form.submit "è³¼å…¥ã™ã‚‹", class: "purchase-button" %>
    
    <div class="terms-notice">
      è³¼å…¥ã™ã‚‹ã“ã¨ã§ã€<a href="/terms">åˆ©ç”¨è¦ç´„</a>ãŠã‚ˆã³<a href="/privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã—ã¾ã™ã€‚<br>
      å•†å“ã«å•é¡ŒãŒã‚ã£ãŸå ´åˆã¯ã€å–å¼•å®Œäº†å‰ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
    </div>
  <% end %>
</div>

<%= content_for :javascript do %>
  <script>
    // ä½æ‰€é¸æŠ
    function selectAddress(element) {
      document.querySelectorAll('.saved-address').forEach(addr => {
        addr.classList.remove('selected');
      });
      element.classList.add('selected');
    }

    // æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
    function selectPayment(element) {
      document.querySelectorAll('.payment-method').forEach(method => {
        method.classList.remove('selected');
      });
      element.classList.add('selected');
      
      const radio = element.querySelector('.radio-input');
      radio.checked = true;
    }

    // ã‚¯ãƒ¼ãƒãƒ³é©ç”¨
    function applyCoupon() {
      const couponCode = document.getElementById('couponCode').value.trim();
      const couponError = document.getElementById('couponError');
      const couponDiscount = document.getElementById('couponDiscount');
      
      if (couponCode === '') {
        couponError.textContent = 'ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        couponError.style.display = 'block';
        return;
      }
      
      // ã‚µãƒ³ãƒ—ãƒ«ã‚¯ãƒ¼ãƒãƒ³
      if (couponCode === 'WELCOME500') {
        couponDiscount.textContent = 'Â¥ -500';
        couponError.style.display = 'none';
        updateTotal();
      } else if (couponCode === 'NEWUSER1000') {
        couponDiscount.textContent = 'Â¥ -1,000';
        couponError.style.display = 'none';
        updateTotal();
      } else {
        couponError.textContent = 'ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã§ã™';
        couponError.style.display = 'block';
        couponDiscount.textContent = 'Â¥ 0';
        updateTotal();
      }
    }

    // åˆè¨ˆé‡‘é¡æ›´æ–°
    function updateTotal() {
      const basePrice = 145000;
      const couponText = document.getElementById('couponDiscount').textContent;
      const pointText = document.getElementById('pointDiscount').textContent;
      
      const couponAmount = couponText === 'Â¥ 0' ? 0 : parseInt(couponText.replace(/[Â¥\s,-]/g, ''));
      const pointAmount = pointText === 'Â¥ 0' ? 0 : parseInt(pointText.replace(/[Â¥\s,-]/g, ''));
      
      const total = basePrice + couponAmount + pointAmount;
      document.getElementById('totalAmount').textContent = `Â¥ ${total.toLocaleString()}`;
    }

    // ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨è¨ˆç®—
    document.querySelector('input[type="number"]').addEventListener('input', function() {
      const points = parseInt(this.value) || 0;
      const maxPoints = 1500;
      
      if (points > maxPoints) {
        this.value = maxPoints;
        return;
      }
      
      document.getElementById('pointDiscount').textContent = points > 0 ? `Â¥ -${points.toLocaleString()}` : 'Â¥ 0';
      updateTotal();
    });
  </script>
<% end %>