<% content_for :title, "#{@product.name} - å•†å“è©³ç´°" %>

<%= content_for :head do %>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
<% end %>

<div class="bg-gray-100 text-gray-800 leading-relaxed min-h-screen">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center gap-4">
        <%= link_to "ãƒ¡ãƒ«ã‚«ãƒª", root_path, class: "text-2xl font-bold text-red-500 no-underline" %>
        <div class="text-sm text-gray-500">
          <%= link_to "ãƒ›ãƒ¼ãƒ ", root_path, class: "text-gray-500 no-underline hover:underline" %> > 
          <% if @product.category_id.present? %>
            <span class="text-gray-500"><%= get_category_name(@product.category_id) %></span> > 
          <% end %>
          <%= truncate(@product.name, length: 30) %>
        </div>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- å•†å“ãƒ¡ã‚¤ãƒ³æƒ…å ± -->
    <div class="grid lg:grid-cols-2 gap-10 bg-white rounded-lg p-8 shadow-sm mb-6">
      <!-- å•†å“ç”»åƒ -->
      <div class="relative">
        <div class="w-full aspect-square rounded-lg overflow-hidden mb-4 border border-gray-200">
          <% if @product.images.any? %>
            <%= image_tag @product.images.first, 
                         alt: @product.name, 
                         id: "mainImage",
                         class: "w-full h-full object-cover cursor-pointer" %>
          <% else %>
            <div id="mainImage" class="w-full h-full bg-gray-100 flex items-center justify-content-center">
              <span class="text-6xl text-gray-400">ğŸ“·</span>
            </div>
          <% end %>
        </div>
        
        <% if @product.images.any? && @product.images.count > 1 %>
          <div class="flex gap-2 overflow-x-auto pb-2">
            <% @product.images.each_with_index do |image, index| %>
              <div class="thumbnail flex-shrink-0 w-20 h-20 rounded-md overflow-hidden border-2 <%= index == 0 ? 'border-red-500' : 'border-transparent hover:border-gray-300' %> cursor-pointer transition-colors" 
                   onclick="changeImage(this, '<%= url_for(image) %>')">
                <%= image_tag image, 
                             alt: "ç”»åƒ#{index + 1}", 
                             class: "w-full h-full object-cover" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- å•†å“æƒ…å ± -->
      <div class="flex flex-col">
        <h1 class="text-2xl font-semibold mb-4 leading-tight"><%= @product.name %></h1>
        
        <div class="text-4xl font-bold text-red-500 mb-2">Â¥ <%= number_with_delimiter(@product.price.to_i) %></div>
        <div class="text-sm text-gray-600 mb-6">
          ï¼ˆç¨è¾¼ï¼‰
          <% if @product.shipping_fee_payer_id == 1 %>
            é€æ–™è¾¼ã¿
          <% else %>
            ç€æ‰•ã„
          <% end %>
        </div>

        <!-- å‡ºå“è€…æƒ…å ± -->
        <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg mb-6">
          <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-xl">ğŸ‘¤</div>
          <div>
            <div class="font-medium mb-1">
              <% if @product.user.present? %>
                <%= @product.user.name || "ãƒ¦ãƒ¼ã‚¶ãƒ¼#{@product.user.id}" %>
              <% else %>
                å‡ºå“è€…
              <% end %>
            </div>
            <div class="flex items-center gap-1 text-sm text-gray-600">
              <span class="text-yellow-400">â˜…</span>
              <span class="text-yellow-400">â˜…</span>
              <span class="text-yellow-400">â˜…</span>
              <span class="text-yellow-400">â˜…</span>
              <span class="text-yellow-400">â˜†</span>
              <span>4.2 (28ä»¶)</span>
            </div>
          </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="flex flex-col gap-3 mb-8">
          <% if @product.respond_to?(:sold?) && @product.sold? %>
            <button class="bg-gray-400 text-white py-4 px-6 rounded-lg text-lg font-semibold cursor-not-allowed" disabled>
              å£²ã‚Šåˆ‡ã‚Œã¾ã—ãŸ
            </button>
          <% else %>
            <%= link_to purchase_product_path(@product), 
                       class: "bg-red-500 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-red-600 transition-colors text-center no-underline" do %>
              è³¼å…¥æ‰‹ç¶šãã¸
            <% end %>
            <button class="bg-gray-600 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-gray-700 transition-colors" onclick="addToCart()">
              ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹
            </button>
          <% end %>
          
          <button class="flex items-center justify-center gap-2 bg-transparent text-gray-600 border border-gray-300 py-3 px-6 rounded-lg text-sm hover:bg-gray-50 transition-all" 
                  id="likeBtn" onclick="toggleLike()">
            <span id="likeIcon">â™¡</span>
            <span id="likeText">ã„ã„ã­</span>
            <span id="likeCount">0</span>
          </button>
        </div>
      </div>
    </div>

    <!-- å•†å“è©³ç´°æƒ…å ± -->
    <div class="bg-white rounded-lg p-8 shadow-sm mb-6">
      <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-100">å•†å“ã®æƒ…å ±</h2>
      
      <table class="w-full border-collapse mb-8">
        <% if @product.category_id.present? %>
          <tr class="border-b border-gray-100">
            <th class="bg-gray-50 text-left p-3 font-medium w-1/3">ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
            <td class="p-3"><%= get_category_name(@product.category_id) %></td>
          </tr>
        <% end %>
        
        <tr class="border-b border-gray-100">
          <th class="bg-gray-50 text-left p-3 font-medium">ãƒ–ãƒ©ãƒ³ãƒ‰</th>
          <td class="p-3">-</td>
        </tr>
        
        <% if @product.condition_id.present? %>
          <tr class="border-b border-gray-100">
            <th class="bg-gray-50 text-left p-3 font-medium">å•†å“ã®çŠ¶æ…‹</th>
            <td class="p-3"><%= get_condition_name(@product.condition_id) %></td>
          </tr>
        <% end %>
        
        <% if @product.shipping_fee_payer_id.present? %>
          <tr class="border-b border-gray-100">
            <th class="bg-gray-50 text-left p-3 font-medium">é…é€æ–™ã®è² æ‹…</th>
            <td class="p-3">
              <% if @product.shipping_fee_payer_id == 1 %>
                é€æ–™è¾¼ã¿ï¼ˆå‡ºå“è€…è² æ‹…ï¼‰
              <% else %>
                ç€æ‰•ã„ï¼ˆè³¼å…¥è€…è² æ‹…ï¼‰
              <% end %>
            </td>
          </tr>
        <% end %>
        
        <tr class="border-b border-gray-100">
          <th class="bg-gray-50 text-left p-3 font-medium">é…é€ã®æ–¹æ³•</th>
          <td class="p-3">ã‚‰ãã‚‰ããƒ¡ãƒ«ã‚«ãƒªä¾¿</td>
        </tr>
        
        <% if @product.prefecture_id.present? %>
          <tr class="border-b border-gray-100">
            <th class="bg-gray-50 text-left p-3 font-medium">ç™ºé€å…ƒã®åœ°åŸŸ</th>
            <td class="p-3"><%= get_prefecture_name(@product.prefecture_id) %></td>
          </tr>
        <% end %>
        
        <% if @product.shipping_day_id.present? %>
          <tr class="border-b border-gray-100">
            <th class="bg-gray-50 text-left p-3 font-medium">ç™ºé€ã¾ã§ã®æ—¥æ•°</th>
            <td class="p-3">
              <% case @product.shipping_day_id %>
              <% when 1 %>
                1ã€œ2æ—¥ã§ç™ºé€
              <% when 2 %>
                2ã€œ3æ—¥ã§ç™ºé€
              <% when 3 %>
                4ã€œ7æ—¥ã§ç™ºé€
              <% else %>
                æœªè¨­å®š
              <% end %>
            </td>
          </tr>
        <% end %>
        
        <tr class="border-b border-gray-100">
          <th class="bg-gray-50 text-left p-3 font-medium">å‡ºå“æ—¥æ™‚</th>
          <td class="p-3"><%= @product.created_at.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M") %></td>
        </tr>
      </table>

      <h3 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-100">å•†å“ã®èª¬æ˜</h3>
      <div class="leading-7 text-gray-700 whitespace-pre-line">
        <% if @product.description.present? %>
          <%= simple_format(@product.description) %>
        <% else %>
          å•†å“ã®èª¬æ˜ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
        <% end %>
      </div>
    </div>

    <!-- é–¢é€£å•†å“ -->
    <% if @related_products&.any? %>
      <div class="bg-white rounded-lg p-8 shadow-sm">
        <h2 class="text-xl font-semibold mb-4 pb-2 border-b border-gray-100">é–¢é€£ã™ã‚‹å•†å“</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
          <% @related_products.each do |product| %>
            <%= link_to product_path(product), class: "border border-gray-200 rounded-lg overflow-hidden hover:transform hover:-translate-y-1 hover:shadow-lg transition-all cursor-pointer no-underline" do %>
              <div class="w-full aspect-square bg-gray-100 flex items-center justify-center overflow-hidden">
                <% if product.images.any? %>
                  <%= image_tag product.images.first, 
                               alt: product.name, 
                               class: "w-full h-full object-cover" %>
                <% else %>
                  <span class="text-4xl text-gray-400">ğŸ“·</span>
                <% end %>
              </div>
              <div class="p-3">
                <div class="text-sm mb-2 line-clamp-2 text-gray-800"><%= truncate(product.name, length: 30) %></div>
                <div class="text-lg font-semibold text-red-500">Â¥ <%= number_with_delimiter(product.price.to_i) %></div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- å®‰å¿ƒãƒ»å®‰å…¨ã¸ã®å–ã‚Šçµ„ã¿ -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
      <div class="font-semibold mb-2 text-yellow-800">å®‰å¿ƒãƒ»å®‰å…¨ã¸ã®å–ã‚Šçµ„ã¿</div>
      <div class="text-sm text-yellow-800">
        ãŠé‡‘ã¯äº‹å‹™å±€ã«æ”¯æ‰•ã‚ã‚Œã€è©•ä¾¡å¾Œã«æŒ¯ã‚Šè¾¼ã¾ã‚Œã¾ã™ã€‚å‡ºå“è€…ã€è³¼å…¥è€…ã¨ã‚‚ã«å®‰å¿ƒã—ã¦ãŠå–å¼•ã„ãŸã ã‘ã¾ã™ã€‚
      </div>
    </div>
  </div>
</div>

<script>
  // ç”»åƒåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
  function changeImage(thumbnail, imageUrl) {
    // ãƒ¡ã‚¤ãƒ³ç”»åƒã‚’å¤‰æ›´
    const mainImage = document.getElementById('mainImage');
    if (mainImage && mainImage.tagName === 'IMG') {
      mainImage.src = imageUrl;
    }
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ ãƒã‚¤ãƒ«ã‚’æ›´æ–°
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      thumb.classList.remove('border-red-500');
      thumb.classList.add('border-transparent', 'hover:border-gray-300');
    });
    thumbnail.classList.remove('border-transparent', 'hover:border-gray-300');
    thumbnail.classList.add('border-red-500');
  }

  // ã„ã„ã­æ©Ÿèƒ½
  function toggleLike() {
    const likeBtn = document.getElementById('likeBtn');
    const likeIcon = document.getElementById('likeIcon');
    const likeText = document.getElementById('likeText');
    const likeCount = document.getElementById('likeCount');
    
    if (likeBtn.classList.contains('liked')) {
      // ã„ã„ã­è§£é™¤
      likeBtn.classList.remove('liked', 'text-red-500', 'border-red-500');
      likeBtn.classList.add('text-gray-600', 'border-gray-300');
      likeIcon.textContent = 'â™¡';
      likeText.textContent = 'ã„ã„ã­';
      likeCount.textContent = parseInt(likeCount.textContent) - 1;
    } else {
      // ã„ã„ã­è¿½åŠ 
      likeBtn.classList.add('liked', 'text-red-500', 'border-red-500');
      likeBtn.classList.remove('text-gray-600', 'border-gray-300');
      likeIcon.textContent = 'â™¥';
      likeText.textContent = 'ã„ã„ã­æ¸ˆã¿';
      likeCount.textContent = parseInt(likeCount.textContent) + 1;
    }
  }

  // ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
  function addToCart() {
    alert('ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // ç”»åƒã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const mainImage = document.getElementById('mainImage');
    if (mainImage) {
      mainImage.addEventListener('click', function() {
        // ç”»åƒæ‹¡å¤§è¡¨ç¤ºã®å®Ÿè£…
        alert('ç”»åƒæ‹¡å¤§è¡¨ç¤ºï¼ˆå®Ÿè£…å¯èƒ½ï¼‰');
      });
    }
  });
</script>
